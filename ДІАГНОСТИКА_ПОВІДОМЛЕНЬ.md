# üîß –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –∑–∞–ø–∏—Å–æ–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

## –ü—Ä–æ–±–ª–µ–º–∞
–ó–∞–ø–∏—Å–∏ –Ω–µ –¥–æ–¥–∞—é—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü—é `act_changes_notifications` –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∑–º—ñ–Ω –≤ –∞–∫—Ç—ñ.

## –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏

### 1Ô∏è‚É£ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è —è–∫ "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä"
- –§—É–Ω–∫—Ü—ñ—è `logActChanges` **–ø—Ä–æ–ø—É—Å–∫–∞—î –∑–∞–ø–∏—Å** —è–∫—â–æ `userAccessLevel === "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä"`
- –¶–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞ (–∞–¥–º—ñ–Ω –Ω–µ –º–∞—î –±–∞—á–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Å–≤–æ—ó –∑–º—ñ–Ω–∏)

### 2Ô∏è‚É£ RLS –ø–æ–ª—ñ—Ç–∏–∫–∞ –±–ª–æ–∫—É—î INSERT
- –¢–∞–±–ª–∏—Ü—è –º–∞—î RLS –ø–æ–ª—ñ—Ç–∏–∫—É, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î INSERT —Ç—ñ–ª—å–∫–∏ –¥–ª—è whitelist –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- Email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –º–∞—î —Å–ø—ñ–≤–ø–∞–¥–∞—Ç–∏ –∑ –æ–¥–Ω–∏–º –∑: `veron3373v@gmail.com`, `bsbraclavec@gmail.com`

### 3Ô∏è‚É£ –ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∑–∞–ø–∏—Å—É
- –Ø–∫—â–æ –≤–∏ –Ω–µ –¥–æ–¥–∞–ª–∏/–≤–∏–¥–∞–ª–∏–ª–∏ –ø–æ–∑–∏—Ü—ñ—ó, —Ç–æ –∑–∞–ø–∏—Å—ñ–≤ –Ω–µ –±—É–¥–µ

## üîç –ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞

### –£–≤—ñ–π–¥—ñ—Ç—å —è–∫ –ù–ï-–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä —ñ –∑–±–µ—Ä–µ–∂—ñ—Ç—å –∞–∫—Ç –∑ –∑–º—ñ–Ω–∞–º–∏

–û—á—ñ–∫—É–≤–∞–Ω—ñ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ:

```
üîç [logActChanges] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: "–°–ª—é—Å–∞—Ä"
‚úÖ [logActChanges] –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ù–ï –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä - –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è
üìã –î–∞–Ω—ñ –∞–∫—Ç—É - –ö–ª—ñ—î–Ω—Ç: "...", –ê–≤—Ç–æ–º–æ–±—ñ–ª—å: "...", –¢–µ–ª–µ—Ñ–æ–Ω: "..."
üìù [logActChanges] –ü—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ X –∑–∞–ø–∏—Å—ñ–≤ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏: [...]
üë§ [logActChanges] –ü–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á: { email: "...", id: "...", role: "..." }
‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ X –∑–º—ñ–Ω –≤ –ë–î (–∑ –∫–ª—ñ—î–Ω—Ç–æ–º —Ç–∞ –∞–≤—Ç–æ)
‚úÖ –í—Å—Ç–∞–≤–ª–µ–Ω—ñ –∑–∞–ø–∏—Å–∏: [...]
```

### ‚ùå –Ø–∫—â–æ –±–∞—á–∏—Ç–µ –ø–æ–º–∏–ª–∫—É

–®—É–∫–∞–π—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—ñ:
```
‚ùå –ü–û–ú–ò–õ–ö–ê –ó–ê–ü–ò–°–£ –ó–ú–Ü–ù:
üìã –î–µ—Ç–∞–ª—ñ –ø–æ–º–∏–ª–∫–∏: { code: "...", message: "...", ... }
```

**–¢–∏–ø–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏:**

1. **RLS Violation** (`42501` –∞–±–æ `new row violates row-level security policy`)
   - **–ü—Ä–∏—á–∏–Ω–∞:** Email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ù–ï –≤ whitelist
   - **–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–π—Ç–µ email –≤ RLS –ø–æ–ª—ñ—Ç–∏–∫—É (–¥–∏–≤. –Ω–∏–∂—á–µ)

2. **Permission denied** (`42501`)
   - **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤
   - **–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏

## üîç –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏ –≤ Supabase

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ **Supabase Dashboard**
2. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ **SQL Editor**
3. –í–∏–∫–æ–Ω–∞–π—Ç–µ —Ñ–∞–π–ª `test_rls_notifications.sql`

### –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

- **RLS enabled:** `true`
- **–ü–æ–ª—ñ—Ç–∏–∫–∏:** 4 –ø–æ–ª—ñ—Ç–∏–∫–∏ (SELECT, INSERT, UPDATE, DELETE) –¥–ª—è authenticated

### –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:

–í–∏–∫–æ–Ω–∞–π—Ç–µ –≤ SQL Editor (–≤—ñ–¥ —ñ–º–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞):
```sql
SELECT auth.jwt() ->> 'email' as current_user_email;
```

–ü–æ—Ä—ñ–≤–Ω—è–π—Ç–µ –∑ whitelist: `veron3373v@gmail.com`, `bsbraclavec@gmail.com`

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è 1: –î–æ–¥–∞—Ç–∏ email –≤ whitelist

–Ø–∫—â–æ –≤–∞—à email **–ù–ï** –≤ whitelist, –≤–∏–∫–æ–Ω–∞–π—Ç–µ –≤ SQL Editor:

```sql
BEGIN;

DO $$
DECLARE
  new_whitelist text[] := ARRAY[
    'veron3373v@gmail.com', 
    'bsbraclavec@gmail.com',
    '–í–ê–®_EMAIL@gmail.com'  -- <-- –î–û–î–ê–ô–¢–ï –°–Æ–î–ò
  ];
BEGIN
  -- –û–Ω–æ–≤–∏—Ç–∏ –ø–æ–ª—ñ—Ç–∏–∫—É INSERT
  DROP POLICY IF EXISTS "whitelist_insert" ON public.act_changes_notifications;
  
  CREATE POLICY "whitelist_insert" ON public.act_changes_notifications
    FOR INSERT TO authenticated
    WITH CHECK (lower(auth.jwt() ->> 'email') = ANY (new_whitelist::text[]));
    
  RAISE NOTICE 'Whitelist –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!';
END $$;

COMMIT;
```

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è 2: –¢–∏–º—á–∞—Å–æ–≤–æ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –≤—Å—ñ–º (–ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω—É)

```sql
DROP POLICY IF EXISTS "whitelist_insert" ON public.act_changes_notifications;

CREATE POLICY "allow_all_insert" ON public.act_changes_notifications
  FOR INSERT TO authenticated
  WITH CHECK (true);
```

## üîç –ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –≤–∏ –Ω–µ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä

–Ø–∫—â–æ –≤ –∫–æ–Ω—Å–æ–ª—ñ –±–∞—á–∏—Ç–µ:
```
‚è≠Ô∏è –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä - –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω –ø—Ä–æ–ø—É—â–µ–Ω–æ
```

–¢–æ —Ü–µ **–Ω–æ—Ä–º–∞–ª—å–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞**! –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –ù–ï –º–∞—î –ª–æ–≥—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏.

### –©–æ–± –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏:
1. –í–∏–π–¥—ñ—Ç—å –∑ —Å–∏—Å—Ç–µ–º–∏
2. –£–≤—ñ–π–¥—ñ—Ç—å —è–∫ **–°–ª—é—Å–∞—Ä** –∞–±–æ —ñ–Ω—à–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á (–ù–ï –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)
3. –ó—Ä–æ–±—ñ—Ç—å –∑–º—ñ–Ω–∏ –≤ –∞–∫—Ç—ñ —Ç–∞ –∑–±–µ—Ä–µ–∂—ñ—Ç—å

## üìä –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

### –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –∑–∞–ø–∏—Å–∏ –¥–æ–¥–∞–ª–∏—Å—è:

–í SQL Editor –≤–∏–∫–æ–Ω–∞–π—Ç–µ:
```sql
SELECT 
  notification_id,
  act_id,
  item_name,
  changed_by_surname,
  dodav_vudaluv,
  pib,
  auto,
  phone,
  delit,
  data
FROM act_changes_notifications
WHERE delit = false
ORDER BY data DESC
LIMIT 10;
```

### –Ø–∫—â–æ –∑–∞–ø–∏—Å—ñ–≤ –Ω–µ–º–∞—î - –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Å—Ç–∞–≤–∫—É –≤—Ä—É—á–Ω—É:

```sql
INSERT INTO act_changes_notifications (
  act_id, item_name, cina, kilkist, zarplata,
  dodav_vudaluv, changed_by_surname, delit, data,
  pib, auto, phone
) VALUES (
  999999, '–¢–ï–°–¢', 100, 1, 0,
  true, 'TEST', false, NOW(),
  '–¢–µ—Å—Ç–æ–≤–∏–π –ö–ª—ñ—î–Ω—Ç', 'Toyota Camry', '0501234567'
);
```

–Ø–∫—â–æ –≤—Ä—É—á–Ω—É –≤—Å—Ç–∞–≤–∫–∞ **–ù–ï –ø—Ä–∞—Ü—é—î** - –ø—Ä–æ–±–ª–µ–º–∞ –≤ RLS.
–Ø–∫—â–æ –≤—Ä—É—á–Ω—É –≤—Å—Ç–∞–≤–∫–∞ **–ø—Ä–∞—Ü—é—î** - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥—ñ TypeScript.

## üìû –Ø–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –¥–æ–ø–æ–º–æ–≥–ª–æ

–ù–∞–¥—ñ—à–ª—ñ—Ç—å –º–µ–Ω—ñ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏:
1. –ö–æ–Ω—Å–æ–ª—ñ –±—Ä–∞—É–∑–µ—Ä–∞ (–≤—Å—ñ –ª–æ–≥–∏ –∑ –µ–º–æ–¥–∑—ñ)
2. –†–µ–∑—É–ª—å—Ç–∞—Ç—É –∑–∞–ø–∏—Ç—É –∑ `test_rls_notifications.sql`
3. –†–µ–∑—É–ª—å—Ç–∞—Ç—É `SELECT auth.jwt() ->> 'email'`
