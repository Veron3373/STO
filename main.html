<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8" />
    <title>–û—Å–Ω–æ–≤–Ω–∏–π</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
</head>

<body class="page-2">
    <ul class="main-menu">
        <div class="menu-items" id="menu-items-to-hide" style="display: none;">
            <li><a href="" id="logout-link" class="menu-link">–í–∏—Ö—ñ–¥</a></li>
            <li><a href="#" class="menu-link" data-action="openSettings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a></li>
            <li><a href="#" class="menu-link all_other_bases" data-action="openClient">–î–æ–¥–∞—Ç–∏</a></li>
            <li><a href="bukhhalteriya.html" class="menu-link all_other_bases_Bukhh"
                    data-action="openBukhhalteriya">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è</a></li>
            <li class="active"><a href="#" class="menu-link" data-action="openHome">–ù–∞—Ä—è–¥</a></li>
            <li><input type="text" id="dateRangePicker" readonly /></li>
            <li class="search-container">
                <span id="searchIcon" class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫..." />
            </li>
        </div>
        <li class="alim">1.2.0 / –ê–ª—ñ–º 2025</li>
    </ul>

    <a href="#" id="open-modal-sakaz_narad"></a>
    <a href="#" id="open-modal-create-sakaz_narad"></a>
    <a href="#" id="open-modal-all_other_bases"></a>
    <a href="#" id="open-modal-settings"></a>
    <a href="#" id="open-modal-Bukhh"></a>

    <div id="table-container-modal-sakaz_narad"></div>

    <script type="module" src="/src/ts/main.ts"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script type="module">
        import { setupSearchWithTableFilter } from "/src/ts/roboha/tablucya/pochuk.ts";
        import { loadActsTable, initializeActsSystem } from "/src/ts/roboha/tablucya/tablucya.ts";
        import { 
            showLoginModalBeforeTable, 
            updateUIBasedOnAccess, // –Ü–º–ø–æ—Ä—Ç—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI
            logoutFromSystemAndRedirect 
        } from "/src/ts/roboha/tablucya/users.ts";

        // –†–æ–±–∏–º–æ logoutFromSystemAndRedirect –≥–ª–æ–±–∞–ª—å–Ω–æ—é
        window.logoutFromSystemAndRedirect = logoutFromSystemAndRedirect;

        /**
         * –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤–∏–¥–∏–º—ñ—Å—Ç—é –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é.
         * –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ initializeSystem.
         */
        function updateMenuVisibility(isVisible) {
            const menu = document.getElementById("menu-items-to-hide");
            if (menu) {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ display, –∞ –Ω–µ –∫–ª–∞—Å, –¥–ª—è –Ω–µ–≥–∞–π–Ω–æ–≥–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è.
                menu.style.display = isVisible ? "flex" : "none";
            }
        }

        /**
         * –§—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏ –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É.
         * –ù–ï –í–ò–ö–õ–ò–ö–ê–Ñ updateUIBasedOnAccess, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ —Ä–æ–±–∏—Ç—å—Å—è –Ω–∏–∂—á–µ.
         */
        function initializeSystem() {
            let currentFilterType = 'open';
            let currentDateFrom = null;
            let currentDateTo = null;
            let isInitialized = false;

            if (isInitialized) return;
            isInitialized = true;

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è DateRangePicker
            $('#dateRangePicker').daterangepicker(
                {
                    // ... (–í–∞—à—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è daterangepicker) ...
                    locale: {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† format: 'DD.MM.YYYY',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† separator: ' - ',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† applyLabel: '–ü—Ä–∏–π–Ω—è—Ç–∏',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† cancelLabel: '–í—ñ–¥–º—ñ–Ω–∏—Ç–∏',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† fromLabel: '–í—ñ–¥',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† toLabel: '–î–æ',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† weekLabel: '–¢–∏–∂',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† daysOfWeek: ['–ù–¥', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'],
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† monthNames: [
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–°—ñ—á–µ–Ω—å', '–õ—é—Ç–∏–π', '–ë–µ—Ä–µ–∑–µ–Ω—å', '–ö–≤—ñ—Ç–µ–Ω—å', '–¢—Ä–∞–≤–µ–Ω—å', '–ß–µ—Ä–≤–µ–Ω—å',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–õ–∏–ø–µ–Ω—å', '–°–µ—Ä–ø–µ–Ω—å', '–í–µ—Ä–µ—Å–µ–Ω—å', '–ñ–æ–≤—Ç–µ–Ω—å', '–õ–∏—Å—Ç–æ–ø–∞–¥', '–ì—Ä—É–¥–µ–Ω—å'
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ],
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† firstDay: 1
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† },
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† opens: 'center',
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† alwaysShowCalendars: true,
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† autoUpdateInput: false,
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† startDate: moment().startOf('year'),
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† endDate: moment(),
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ranges: {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–í—ñ–¥–∫—Ä–∏—Ç—ñ': [moment().startOf('year'), moment()],
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–ó–∞–∫—Ä–∏—Ç—ñ': [moment('02.01.2025', 'DD.MM.YYYY'), moment()],
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–í—ñ–¥ –ø–æ—á–∞—Ç–∫—É': [moment('03.01.2025', 'DD.MM.YYYY'), moment()],
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–°—å–æ–≥–æ–¥–Ω—ñ': [moment(), moment()],
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–û—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤': [moment().subtract(6, 'days'), moment()],
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–ü–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å': [moment().startOf('month'), moment().endOf('month')],
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† '–ú–∏–Ω—É–ª–∏–π –º—ñ—Å—è—Ü—å': [
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† moment().subtract(1, 'month').startOf('month'),
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† moment().subtract(1, 'month').endOf('month')
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ]
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† },
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showCustomRangeLabel: false
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† },
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† function (start, end, label) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (label === '–í—ñ–¥–∫—Ä–∏—Ç—ñ') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $('#dateRangePicker').val('–í—ñ–¥–∫—Ä–∏—Ç—ñ');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $('#dateRangePicker').data('daterangepicker').element.removeClass('active-range');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentFilterType = 'open';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentDateFrom = null;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentDateTo = null;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† loadActsTable(null, null, 'open');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.setStartDate(moment().startOf('year'));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.setEndDate(moment());
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (label === '–ó–∞–∫—Ä–∏—Ç—ñ') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $('#dateRangePicker').val('–ó–∞–∫—Ä–∏—Ç—ñ');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $('#dateRangePicker').data('daterangepicker').element.removeClass('active-range');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentFilterType = 'closed';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentDateFrom = null;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentDateTo = null;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† loadActsTable(null, null, 'closed');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.setStartDate(moment('02.01.2025', 'DD.MM.YYYY'));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.setEndDate(moment());
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const formatted = `${start.format('DD.MM.YYYY')} - ${end.format('DD.MM.YYYY')}`;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $('#dateRangePicker').val(formatted);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† $('#dateRangePicker').data('daterangepicker').element.addClass('active-range');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentFilterType = 'date_range';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentDateFrom = start.format("YYYY-MM-DD 00:00:00");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentDateTo = end.format("YYYY-MM-DD 23:59:59");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† loadActsTable(currentDateFrom, currentDateTo, null);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
            );

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑ "–í—ñ–¥–∫—Ä–∏—Ç—ñ" –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É
            $('#dateRangePicker').val('–í—ñ–¥–∫—Ä–∏—Ç—ñ');
            currentFilterType = 'open';

            const picker = $('#dateRangePicker').data('daterangepicker');
            if (picker) {
                picker.setStartDate(moment().startOf('year'));
                picker.setEndDate(moment());
            }

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—à—É–∫—É —Ç–∞ —Ç–∞–±–ª–∏—Ü—ñ
            const searchHandler = setupSearchWithTableFilter(
                loadActsTable,
                () => currentFilterType,
                () => ({ dateFrom: currentDateFrom, dateTo: currentDateTo })
            );
            window.searchHandler = searchHandler;

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏ (–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ)
            initializeActsSystem(); 
            updateMenuVisibility(true); // –ü–æ–∫–∞–∑—É—î–º–æ –º–µ–Ω—é –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        }

        window.initializeSystem = initializeSystem;

        /**
         * –ì–æ–ª–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞: –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
         * –ë–ª–æ–∫—É—î –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è, –¥–æ–∫–∏ –Ω–µ –±—É–¥–µ –æ—Ç—Ä–∏–º–∞–Ω–æ —Ä—ñ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø—É.
         */
        async function startAuthenticationAndInit() {
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –º–µ–Ω—é, –ø–æ–∫–∏ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ –¥–æ—Å—Ç—É–ø (–∑–∞–±–µ–∑–ø–µ—á–µ–Ω–æ style="display: none;" —É HTML)
            // –ß–µ–∫–∞—î–º–æ, –¥–æ–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É–≤—ñ–π–¥–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∞–±–æ –≤—Ä—É—á–Ω—É)
            const accessLevel = await showLoginModalBeforeTable();
            
            // –Ø–∫—â–æ –¥–æ—Å—Ç—É–ø –æ—Ç—Ä–∏–º–∞–Ω–æ
            if (accessLevel) {
                // 1. –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –¥–æ—Å—Ç—É–ø—É
                await updateUIBasedOnAccess(accessLevel); 

                // 2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å–∏—Å—Ç–µ–º—É (—è–∫–∞ –≤–∏–∫–ª–∏—á–µ initializeActsSystem —Ç–∞ updateMenuVisibility(true))
                initializeSystem();
            } else {
                // –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è —É–≤—ñ–π—Ç–∏, –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –∞–ª–µ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å–∏—Å—Ç–µ–º—É
                console.error("‚ùå –í—Ö—ñ–¥ –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–¥—ñ–π—Å–Ω–∏—Ç–∏. –°–∏—Å—Ç–µ–º–∞ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞.");
            }
        }

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
        startAuthenticationAndInit(); 
    </script>
</body>

</html>