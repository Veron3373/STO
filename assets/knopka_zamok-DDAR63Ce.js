import{s as m}from"./supabaseClient-CaENmPBY.js";import{d as u,e as p,f as v,h as S,j as A,r as N,k as L,A as M,n as $,o as k}from"./main-DcNxIomJ.js";import"./supabase-DjCBILTv.js";import"./pdf-yBvge-Eo.js";function y(t){return(t??"").replace(/\u00A0/g," ").trim()}function E(t){const e=y(t).replace(/\s/g,"").replace(",","."),a=parseFloat(e);return isFinite(a)?a:0}function g(t){if(!t)return null;const e=new Date(t);if(isNaN(+e))return null;const a=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${a}-${s}-${o}`}async function b(t){const{data:e,error:a}=await m.from("acts").select("date_on, date_off").eq("act_id",t).single();return a?(console.warn("Не вдалося прочитати дати акту:",a.message),{date_on:null,date_off:null}):{date_on:(e==null?void 0:e.date_on)??null,date_off:(e==null?void 0:e.date_off)??null}}async function x(t){if(t.length===0)return new Map;const{data:e,error:a}=await m.from("sclad").select("sclad_id, rahunok, time_off").in("sclad_id",Array.from(new Set(t)));if(a)return console.warn("fetchScladMeta():",a.message),new Map;const s=new Map;for(const o of e||[])s.set(Number(o.sclad_id),{rahunok:o.rahunok??null,time_off:o.time_off??null});return s}async function T(t){const{data:e,error:a}=await m.from("shops").select("shop_id, data").eq("data->>Name",t).maybeSingle();return a?(console.warn(`fetchShopByName(${t}):`,a.message),null):e?{shop_id:e.shop_id,data:e.data}:null}async function K(t){if(!t.shop_id)return;const{error:e}=await m.from("shops").update({data:t.data}).eq("shop_id",t.shop_id);if(e)throw new Error(`Не вдалося оновити shops#${t.shop_id}: ${e.message}`)}function B(t){return(!t.data||typeof t.data!="object")&&(t.data={}),(!t.data.Історія||typeof t.data.Історія!="object")&&(t.data.Історія={}),t.data.Історія}function D(){const t=[];return document.querySelectorAll(`#${M} tbody tr`).forEach(a=>{const s=a.querySelector('[data-name="name"]');if(!s)return;let o=s.getAttribute("data-type");const f=y(s.textContent);if(!f)return;if(!o||o!=="details"&&o!=="works"){const R=new Set(p.works).has(f),F=new Set(p.details).has(f);o=R&&!F?"works":"details",s.setAttribute("data-type",o)}if(o!=="details")return;const n=a.querySelector('[data-name="id_count"]'),c=a.querySelector('[data-name="price"]'),i=a.querySelector('[data-name="catalog"]'),l=a.querySelector('[data-name="pib_magazin"]'),w=y(i==null?void 0:i.textContent)||null,h=E(n==null?void 0:n.textContent),d=E(c==null?void 0:c.textContent),r=y(l==null?void 0:l.textContent),_=i==null?void 0:i.getAttribute("data-sclad-id"),C=_?Number(_):null;r&&t.push({shopName:r,sclad_id:C,Найменування:f,Каталог:w,Кількість:h,Ціна:d})}),t}async function I(t){const e=new Map,a=[];for(const n of t.detailRows){const c=(n.shopName||"").trim();c&&(n.sclad_id&&a.push(n.sclad_id),e.has(c)||e.set(c,[]),e.get(c).push({sclad_id:n.sclad_id,Найменування:n.Найменування,Каталог:n.Каталог,Кількість:n.Кількість,Ціна:n.Ціна}))}const s=await x(a),{date_off:o}=await b(t.actId),f=g(o);for(const[n,c]of e.entries()){const i=await T(n);if(!i){u(`Магазин "${n}" не знайдено у shops — пропущено`,"warning",1800);continue}const l=[];for(const r of c){const _=r.sclad_id&&s.get(r.sclad_id)||null;l.push({sclad_id:r.sclad_id,Каталог:r.Каталог?isNaN(Number(r.Каталог))?r.Каталог:Number(r.Каталог):null,Ціна:Number(r.Ціна)||0,Рахунок:_?_.rahunok??null:null,Кількість:Number(r.Кількість)||0,Найменування:r.Найменування})}const w=B(i);w[t.dateKey]||(w[t.dateKey]=[]);const h=w[t.dateKey];let d=h.find(r=>Number(r==null?void 0:r.Акт)===Number(t.actId));d||(d={Акт:t.actId,Деталі:[],ДатаЗакриття:f??null},h.push(d)),d.Деталі=l,d.ДатаЗакриття=f??null,await K(i)}}const O=["адміністратор","адміністатор","full","admin","administrator"];function V(){var s;const t=(typeof k=="string"?k:"")||"",e=((s=$)==null?void 0:s())||null;return(t||(e==null?void 0:e.access)||(e==null?void 0:e.Доступ)||"").toString().normalize("NFKC").trim().toLowerCase()}function j(){return O.includes(V())}let q=!1;function G(){q||(q=!0,document.addEventListener("click",async t=>{var f;const e=t.target,a=(f=e==null?void 0:e.closest)==null?void 0:f.call(e,"#status-lock-btn");if(!a)return;const s=a.getAttribute("data-act-id"),o=s?Number(s):NaN;if(!Number.isFinite(o)){console.error("data-act-id на кнопці відсутній/некоректний"),u("Помилка: не визначено ID акту","error");return}if(!a.disabled){a.disabled=!0;try{if(p.isActClosed){if(!j()){u("❌ Тільки адміністратор може відкривати закриті акти","error",4e3),a.disabled=!1;return}if(!await v(o)){u("Скасовано відкриття акту","warning"),a.disabled=!1;return}u("Відкриття акту...","info");const{data:c,error:i}=await m.from("sclad").select("sclad_id").eq("akt",o);if(i)throw new Error("Не вдалося отримати записи складу: "+i.message);if(c&&c.length>0){const{error:d}=await m.from("sclad").update({time_off:null}).eq("akt",o);if(d)throw new Error("Не вдалося очистити time_off: "+d.message)}const{error:l}=await m.from("acts").update({date_off:null}).eq("act_id",o);if(l)throw new Error("Не вдалося відкрити акт: "+l.message);const{date_on:w}=await b(o),h=g(w);if(h){const d=D();d.length&&await I({actId:o,dateKey:h,detailRows:d})}else u("Не вдалось визначити дату відкриття акту — Історія в shops не оновлена","warning",2e3);p.isActClosed=!1,await S(),await A(o),N(),u("Акт успішно відкрито","success")}else{if(!await L(o)){u("Скасовано закриття акту","warning"),a.disabled=!1;return}u("Закриття акту...","info");const{data:c,error:i}=await m.from("sclad").select("sclad_id").eq("akt",o);if(i)throw new Error("Не вдалося отримати записи складу: "+i.message);const l=new Date().toISOString();if(c&&c.length>0){const{error:r}=await m.from("sclad").update({time_off:l}).eq("akt",o);if(r)throw new Error("Не вдалося оновити time_off: "+r.message)}const{error:w}=await m.from("acts").update({date_off:l}).eq("act_id",o);if(w)throw new Error("Не вдалося закрити акт: "+w.message);const{date_on:h}=await b(o),d=g(h);if(d){const r=D();r.length&&await I({actId:o,dateKey:d,detailRows:r})}else u("Не вдалось визначити дату відкриття акту — Історія в shops не оновлена","warning",2e3);p.isActClosed=!0,await S(),await A(o),N(),u("Акт успішно закрито","success")}}catch(n){console.error("Помилка в обробнику статус-замка:",n),u("Помилка: "+((n==null?void 0:n.message)||n),"error")}finally{a.disabled=!1}}}))}export{G as initStatusLockDelegation};
