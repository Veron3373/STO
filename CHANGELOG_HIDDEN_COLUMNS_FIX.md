# Виправлення збереження прихованих колонок для всіх ролей

## Проблема
При додаванні нового рядка та збереженні акту користувачами з прихованими колонками (Слюсар, Приймальник, Складовщик, Запчастист) дані з прихованих колонок (Ціна, Сума, Зар-та, ПІБ_Магазин) не зберігалися в базу даних, бо:
- Приховані колонки не відображалися в DOM
- При збереженні система брала дані тільки з DOM
- Кешування працювало тільки для Слюсаря

## Рішення

### 1. Змінено структуру кешу (`zberechennya_zmin_y_danux_aktu.ts`)
**Було:**
```typescript
const hiddenColumnsCache = new Map<string, number>(); // Тільки ціни
```

**Стало:**
```typescript
const fullRowDataCache = new Map<string, ParsedItem>(); // Повні дані рядків
// Ключ: "type:name" (наприклад, "detail:Масляний фільтр")
```

### 2. Оновлено функцію кешування
**Функція:** `cacheHiddenColumnsData()`
- **Було:** Кешувала тільки ціни і тільки для Слюсаря
- **Стало:** Кешує ПОВНІ дані рядків (type, name, price, sum, catalog, quantity, slyusarSum, pibMagazin) для ВСІХ ролей

### 3. Повністю переписано функцію збору даних
**Функція:** `parseTableRows()`

**Логіка:**
1. Для кожного рядка створюється ключ `"type:name"`
2. Для кожної колонки перевіряється видимість через `offsetParent !== null`
3. Якщо колонка **видима** → беремо дані з DOM
4. Якщо колонка **прихована** → беремо дані з кешу
5. Після збору даних кеш автоматично оновлюється актуальними значеннями

**Приклад:**
```typescript
// Ціна: якщо видима - з DOM, якщо прихована - з кешу
if (priceCell && priceCell.offsetParent !== null) {
  price = parseNum(priceCell.textContent);
} else if (cachedData) {
  price = cachedData.price;
}
```

### 4. Оновлено застосування обмежень до нових рядків
**Функція:** `applyAccessRestrictionsToNewRow()` в `modalMain.ts`
- **Було:** Викликалася тільки для Слюсаря
- **Стало:** Викликається для ВСІХ ролей і використовує `canUserSeePriceColumns()` для перевірки прав

## Як це працює

### Сценарій 1: Адміністратор створює акт → Слюсар редагує
1. **Адміністратор** відкриває акт, вводить:
   - Деталь: "Масляний фільтр", Ціна: 113, Сума: 113, Магазин: "Exist"
   - Робота: "Заміна сідел клапана", Ціна: 340, Сума: 340, Зар-та: 170

2. **Слюсар** відкриває той самий акт:
   - `cacheHiddenColumnsData()` зберігає ВСІ дані в `fullRowDataCache`
   - Колонки "Ціна", "Сума", "Зар-та", "ПІБ_Магазин" приховуються через CSS
   - Слюсар бачить тільки: №, Найменування, Каталог, К-ть

3. **Слюсар** змінює кількість з 1 на 2 та зберігає:
   - `parseTableRows()` перевіряє видимість кожної колонки
   - `quantityCell.offsetParent !== null` → true → беремо з DOM: `quantity = 2`
   - `priceCell.offsetParent !== null` → false → беремо з кешу: `price = 113`
   - `sumCell.offsetParent !== null` → false → беремо з кешу: `sum = 113`
   - Об'єднуємо дані: `{ name: "Масляний фільтр", quantity: 2, price: 113, sum: 113, ... }`
   - Зберігаємо в базу даних **повні дані**

### Сценарій 2: Слюсар додає новий рядок
1. Слюсар натискає "➕ Додати рядок"
2. Викликається `addNewRow()` → створює порожній рядок в DOM
3. Викликається `applyAccessRestrictionsToNewRow()` → приховує колонки Ціна/Сума
4. Слюсар вводить:
   - Найменування: "Нова деталь"
   - Кількість: 5
5. Натискає "Зберегти зміни"
6. `parseTableRows()`:
   - Створює ключ: `"detail:Нова деталь"`
   - Перевіряє кеш: `fullRowDataCache.get("detail:Нова деталь")` → undefined
   - Бере дані з DOM: `quantity = 5`
   - Для прихованих полів (Ціна, Сума) використовує 0 (бо немає в кеші)
   - Зберігає в базу даних

## Переваги
✅ **Універсальність:** Працює для ВСІХ ролей (Слюсар, Приймальник, Складовщик, Запчастист)  
✅ **Автоматичність:** Не потрібно вручну викликати функції кешування  
✅ **Надійність:** Дані завжди зберігаються, навіть якщо колонки приховані  
✅ **Простота:** Одна функція `parseTableRows()` обробляє всі випадки

## Змінені файли
1. `src/ts/roboha/zakaz_naraudy/inhi/zberechennya_zmin_y_danux_aktu.ts`
   - Змінено структуру кешу
   - Оновлено `cacheHiddenColumnsData()`
   - Повністю переписано `parseTableRows()`

2. `src/ts/roboha/zakaz_naraudy/modalMain.ts`
   - Оновлено `applyAccessRestrictionsToNewRow()` для всіх ролей
   - Змінено обробник кнопки "Додати рядок"
