<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8" />
    <title>–û—Å–Ω–æ–≤–Ω–∏–π</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="icon" type="image/svg+xml" href="/STO/logo.jpg" />
</head>

<body class="page-2">
    <ul class="main-menu">
        <div class="user-info">
            <div class="user-surname">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div class="user-access">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
        <div class="menu-items" id="menu-items-to-hide" style="display: none;">
            <li><a href="" id="logout-link" class="menu-link">–í–∏—Ö—ñ–¥</a></li>
            <li><a href="#" class="menu-link" data-action="openSettings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a></li>
            <li><a href="#" class="menu-link all_other_bases" data-action="openClient">–î–æ–¥–∞—Ç–∏</a></li>
            <li><a href="bukhhalteriya.html" class="menu-link all_other_bases_Bukhh"
                    data-action="openBukhhalteriya">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è</a></li>
            <li class="active"><a href="#" class="menu-link" data-action="openHome">–ù–∞—Ä—è–¥</a></li>
            <li><input type="text" id="dateRangePicker" readonly /></li>
            <li class="search-container">
                <span id="searchIcon" class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫..." />
            </li>
        </div>
        <li class="alim">1.2.0 / ¬© 2025 –ê–ª—ñ–º</li>
    </ul>

    <a href="#" id="open-modal-sakaz_narad"></a>
    <a href="#" id="open-modal-create-sakaz_narad"></a>
    <a href="#" id="open-modal-all_other_bases"></a>
    <a href="#" id="open-modal-settings"></a>
    <a href="#" id="open-modal-Bukhh"></a>

    <div id="table-container-modal-sakaz_narad"></div>

    <script type="module" src="/src/ts/main.ts"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script type="module">
        import { setupSearchWithTableFilter } from "/src/ts/roboha/tablucya/pochuk.ts";
        import { loadActsTable, initializeActsSystem } from "/src/ts/roboha/tablucya/tablucya.ts";
        import {
            showLoginModalBeforeTable,
            updateUIBasedOnAccess,
            logoutFromSystemAndRedirect
        } from "/src/ts/roboha/tablucya/users.ts";

        // –†–æ–±–∏–º–æ logoutFromSystemAndRedirect –≥–ª–æ–±–∞–ª—å–Ω–æ—é
        window.logoutFromSystemAndRedirect = logoutFromSystemAndRedirect;

        /**
         * –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤–∏–¥–∏–º—ñ—Å—Ç—é –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é.
         */
        function updateMenuVisibility(isVisible) {
            const menu = document.getElementById("menu-items-to-hide");
            if (menu) {
                menu.style.display = isVisible ? "flex" : "none";
            }
        }

        /**
         * –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –º–µ–Ω—é
         */
        function updateUserInfoDisplay() {
            try {
                const storedData = localStorage.getItem("userAuthData");
                if (storedData) {
                    const userData = JSON.parse(storedData);
                    const userSurnameElement = document.querySelector('.user-surname');
                    const userAccessElement = document.querySelector('.user-access');

                    if (userSurnameElement && userData.Name) {
                        userSurnameElement.textContent = userData.Name;
                    }

                    if (userAccessElement && userData.–î–æ—Å—Ç—É–ø) {
                        userAccessElement.textContent = userData.–î–æ—Å—Ç—É–ø;
                    }

                    console.log('‚úÖ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –æ–Ω–æ–≤–ª–µ–Ω–æ:', userData.Name, userData.–î–æ—Å—Ç—É–ø);
                }
            } catch (error) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', error);
            }
        }

        /**
         * –§—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏ –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É.
         */
        function initializeSystem() {
            let currentFilterType = 'open';
            let currentDateFrom = null;
            let currentDateTo = null;
            let isInitialized = false;

            if (isInitialized) return;
            isInitialized = true;

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è DateRangePicker
            $('#dateRangePicker').daterangepicker(
                {
                    locale: {
                        format: 'DD.MM.YYYY',
                        separator: ' - ',
                        applyLabel: '–ü—Ä–∏–π–Ω—è—Ç–∏',
                        cancelLabel: '–í—ñ–¥–º—ñ–Ω–∏—Ç–∏',
                        fromLabel: '–í—ñ–¥',
                        toLabel: '–î–æ',
                        weekLabel: '–¢–∏–∂',
                        daysOfWeek: ['–ù–¥', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'],
                        monthNames: [
                            '–°—ñ—á–µ–Ω—å', '–õ—é—Ç–∏–π', '–ë–µ—Ä–µ–∑–µ–Ω—å', '–ö–≤—ñ—Ç–µ–Ω—å', '–¢—Ä–∞–≤–µ–Ω—å', '–ß–µ—Ä–≤–µ–Ω—å',
                            '–õ–∏–ø–µ–Ω—å', '–°–µ—Ä–ø–µ–Ω—å', '–í–µ—Ä–µ—Å–µ–Ω—å', '–ñ–æ–≤—Ç–µ–Ω—å', '–õ–∏—Å—Ç–æ–ø–∞–¥', '–ì—Ä—É–¥–µ–Ω—å'
                        ],
                        firstDay: 1
                    },
                    opens: 'center',
                    alwaysShowCalendars: true,
                    autoUpdateInput: false,
                    startDate: moment().startOf('year'),
                    endDate: moment(),
                    ranges: {
                        '–í—ñ–¥–∫—Ä–∏—Ç—ñ': [moment().startOf('year'), moment()],
                        '–ó–∞–∫—Ä–∏—Ç—ñ': [moment('02.01.2025', 'DD.MM.YYYY'), moment()],
                        '–í—ñ–¥ –ø–æ—á–∞—Ç–∫—É': [moment('03.01.2025', 'DD.MM.YYYY'), moment()],
                        '–°—å–æ–≥–æ–¥–Ω—ñ': [moment(), moment()],
                        '–û—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤': [moment().subtract(6, 'days'), moment()],
                        '–ü–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å': [moment().startOf('month'), moment().endOf('month')],
                        '–ú–∏–Ω—É–ª–∏–π –º—ñ—Å—è—Ü—å': [
                            moment().subtract(1, 'month').startOf('month'),
                            moment().subtract(1, 'month').endOf('month')
                        ]
                    },
                    showCustomRangeLabel: false
                },
                function (start, end, label) {
                    if (label === '–í—ñ–¥–∫—Ä–∏—Ç—ñ') {
                        $('#dateRangePicker').val('–í—ñ–¥–∫—Ä–∏—Ç—ñ');
                        $('#dateRangePicker').data('daterangepicker').element.removeClass('active-range');
                        currentFilterType = 'open';
                        currentDateFrom = null;
                        currentDateTo = null;
                        loadActsTable(null, null, 'open');
                        this.setStartDate(moment().startOf('year'));
                        this.setEndDate(moment());
                    } else if (label === '–ó–∞–∫—Ä–∏—Ç—ñ') {
                        $('#dateRangePicker').val('–ó–∞–∫—Ä–∏—Ç—ñ');
                        $('#dateRangePicker').data('daterangepicker').element.removeClass('active-range');
                        currentFilterType = 'closed';
                        currentDateFrom = null;
                        currentDateTo = null;
                        loadActsTable(null, null, 'closed');
                        this.setStartDate(moment('02.01.2025', 'DD.MM.YYYY'));
                        this.setEndDate(moment());
                    } else {
                        const formatted = `${start.format('DD.MM.YYYY')} - ${end.format('DD.MM.YYYY')}`;
                        $('#dateRangePicker').val(formatted);
                        $('#dateRangePicker').data('daterangepicker').element.addClass('active-range');
                        currentFilterType = 'date_range';
                        currentDateFrom = start.format("YYYY-MM-DD 00:00:00");
                        currentDateTo = end.format("YYYY-MM-DD 23:59:59");
                        loadActsTable(currentDateFrom, currentDateTo, null);
                    }
                }
            );

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑ "–í—ñ–¥–∫—Ä–∏—Ç—ñ" –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É
            $('#dateRangePicker').val('–í—ñ–¥–∫—Ä–∏—Ç—ñ');
            currentFilterType = 'open';

            const picker = $('#dateRangePicker').data('daterangepicker');
            if (picker) {
                picker.setStartDate(moment().startOf('year'));
                picker.setEndDate(moment());
            }

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—à—É–∫—É —Ç–∞ —Ç–∞–±–ª–∏—Ü—ñ
            const searchHandler = setupSearchWithTableFilter(
                loadActsTable,
                () => currentFilterType,
                () => ({ dateFrom: currentDateFrom, dateTo: currentDateTo })
            );
            window.searchHandler = searchHandler;

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏ (–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ)
            initializeActsSystem();
            updateMenuVisibility(true);
        }

        window.initializeSystem = initializeSystem;

        /**
         * –ì–æ–ª–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞: –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
         */
        async function startAuthenticationAndInit() {
            const accessLevel = await showLoginModalBeforeTable();

            if (accessLevel) {
                // 1. –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –¥–æ—Å—Ç—É–ø—É
                await updateUIBasedOnAccess(accessLevel);

                // 2. –ó–∞–ø–æ–≤–Ω—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –º–µ–Ω—é
                updateUserInfoDisplay();

                // 3. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å–∏—Å—Ç–µ–º—É
                initializeSystem();
            } else {
                console.error("‚ùå –í—Ö—ñ–¥ –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–¥—ñ–π—Å–Ω–∏—Ç–∏. –°–∏—Å—Ç–µ–º–∞ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞.");
            }
        }

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
        startAuthenticationAndInit(); 
    </script>
</body>

</html>